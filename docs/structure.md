# 仕様書（簡易版）

## 概要

住所データを以下のような手順で分解する。

1. 都道府県
2. 市町村（区分が大きいもの）
3. 市町村（区分が小さいもの）（※データによっては空になる）
4. 行政区分（名古屋市 中村区 鳥森町 の場合は、鳥森町 がここに分類）3.と同様に、データによっては空になる。
5. 区分がうまくいかなかったもの（ここをできるだけ空白にする。）ここが、空白でない行に関してはCautionをなんらかの形で出す
6. 番地 (1-5-18 のようなものを想定)
7. 建物名 (例: お菓子タワー15 の場合は、前処理で全角の'ー'が'-'に変換されているが、これは全角のものに戻す。)（※ 8. の建物の号室or階数とを分離しているのは、完全に経験則（ヒューリスティック？）なのでバグは発生しうる）(ここは、正確性優先にするかどうするか？)
8. 建物の階数or号室

## 前処理

1. 全角の空白、半角の空白、タブの削除
2. 全角の算用数字(例: ７、４、６)は半角の算用数字へ変換
3. 全角の漢数字を半角の算用数字へ変換
4. 丁目,番地,番,の が各住所データないに存在する場合は、'-'（半角）に置換する。（この際、上記の４つワードが固有名詞に含まれる住所の場合は現在の段階では置換の対象となってしまっている。）
5. 全角の'ー'を半角の'-'に置換

## 都道府県の抽出

47都道府県の文字列リスト（C++では、`vector<sting>`,TypeScriptでは`string[]`で表記される型で保存）によって、確実に都道府県名のみを住所データから抜き出す。

## 市町村の抽出

1. まず、市、区、郡、町、村、を抜き出す。この際、抜き出し方は、各文字列を前方から順に線形探索し始めて上記のキーワードが出現した場所で、文字列を分割するという方針をとる。`市、区、郡、町、村`の優先順なのは、例として`千葉県千葉市花見川区`のように政令指定都市は`市`->`区`の順番で登場するためである。同様の理由から`郡`->`町`,`村`の順番にしている。

2. 1.とほぼ同様な手順でさらに小さな行政単位の名称の抽出にあたる。順番は`区、郡、町、村`である。（存在しない場合は""となる。）

3. 次に、`市、区、郡、町、村`などの接尾辞がついていないが、数字が登場する前に存在する文字列を抜き出す。（具体的には、`福島県いわき市常磐西郷町落合`の`落合`がここに相当する）（存在しない場合は""となる。）

## 番地の抽出

正規表現で`(([0-9]+)-)+([0-9]+)`のように表せる部分を抽出する。
この際、上記の正規表現で抽出された範囲より前方にある不明な部分を`others_head`、後方の不明な部分を`others_tail`とする。

## othersの取り扱い

※以下未実装項目も含む

前述の`others_tail`の中で、英数字と`-`のみで形成されている場合は、これを`house_number`にデータを所属変更させる。

また、`others_tail`の開始文字列が`-`、数字の場合は、その部分だけ抽出しその文字列情報を`house_number`に移行する。

この時点で、`others_tail`に含まれる情報は、日本語がすくなくとも１つ含まれる状態になっているので、ここで半角の`-`を全角の`ー`に戻す。これは例として、`お菓子タワー`のような文字列が`お菓子タワ-`となっているものを適切な表現に戻すことを目的としている。

さらに、ビル名と階数または、建物名と号室情報を分離するために処理を行う。
このとき、`船橋ケアセンター東棟`のような情報も分離する必要があるか、それとも、`南麻布レジデンス508`の`508`だけを分離するのかで実装が変化するのでこの辺りについても仕様を詰めたい。

## caution 

エラー文を出力する。
エラーは、対象の列にあるべきではない文字列を検知した場合や、想定していないデータが入力された時、または、市町村、町域に関する`自動チェック機構`が参照するデータセットと異なる文字列が存在したときなどに発出される。

また、エラーかどうかの判断はつかないが高確率でエラーと思われる場合も`ERROR:`と出力され、そこまで高確率ではないが誤りかもしれない程度のものに関しては`CAUTION:`が出力される。

## 出力形式

出力ファイルは`output.csv`として出力する。また、カラム名は左から順に、`original`,`prefecture`,`address1`,`address2`,`address3`,`address4`.`address5`,`caution`となる。

- `original`
この列には、整形前の元データそのままを入れる。これはチェック作業時に元データを確認しやすくするためである。

- `prefecture`
47都道府県のどれかが入る。ここが空の場合は`caution`に警告がでる。存在しない都道府県はここには、`〜県`という要件を満たしていても入らない。

- `address1`
品川区や、いわき市、千葉市花見川区 などが入る。ここに関しても、存在しない場合は`caution`に警告が出る。ただし、漢字表記がひらがな表記になっている場合や、2021年4月時点での名称と異なるデータの場合は、実際には正しい表記でも`caution`が出る場合がある。

- `address2`
西六郷、中町、大井 などの町域が入る。ここに関しても、存在しない場合は`caution`がでる。`address1`と同様に表記が、プログラムが参照する2021年4月時点での日本郵便APIのデータセットと文字列が、異なる場合は正しい場合でも`caution`が出る可能性がある。

- `address3`
`1-8-6`のような番地が入る。この列に関しては、実在するか否かの自動チェック機構は働いていない。そのため、存在しない場合でも`caution`は出力されない。

- `address4`
衆議院第1会館, 〜マンション などの建物名と思しき文字列が入る。この列に関しても`address3`と同様に自動チェック機構は働いていない。

- `address5`
401, 6F, 6号, 902号, 3号館 などの建物の詳細情報と思しき文字列が入る。この列に関しても`address3`と同様に自動チェック機構は働いていない。

- `caution`
警告文が入る。警告文の内容については、`ERROR:`が`高確率で間違いである`ことを表し、`CAUTION:`が`ある程度の確率で誤りである`ことを示す。

複数のエラー文が出ている時は、そもそも自動整形が正しく働かなかった可能性が高いので、エラー文を読むより、そのエラーが出ている行全体をチェックすることを推奨する。
